import{r as c,y as I,o as P,B as w,s as y,A as U,e as m,f as t,t as v,F as Y,k as x,j as d,w as H,m as N,n as B,a as p,d as _,z as R,p as S,h as F,D as L,b}from"./index-Dd8u3veE.js";import{h as f}from"./moment-C5S46NFB.js";import{_ as E}from"./_plugin-vue_export-helper-DlAUqK2U.js";const V={key:0,class:"RoomContainer"},$={class:"RoomHeader"},z=["src"],K={class:"RoomName"},j={class:"message"},A={class:"time"},q={class:"top"},G=["src"],J=["src"],O={class:"RoomInput"},Q={class:"inputBox"},W={__name:"DMRoom",setup(X){const C=L(),a=c(null),M=c(!1),g=c(!1),o=c({Room_ID:null,User_Name:null,Messages:[]}),r=c({});I(()=>o.value.Messages,async l=>{for(const s of o.value.Messages){const n=s.Message;s.type=="1"&&r.value[n]==null&&p.post("/feeds/Post_tinyInfo",{Post_ID:n},{withCredentials:!0}).then(e=>{const i=e.data;r.value[n]={Post_ID:n,User_ID:i.User_ID,User_Name:i.User_Name,Profile_Img:i.Profile_Img,Image_Src:i.Image_Src,Post_Caption:i.Post_Caption,Post_Title:i.Post_Title}}).catch(e=>{console.log(e)})}}),I(()=>C.params.Room_ID,l=>{l?(g.value=!0,p.get(`/Direct/print_DM/${l}`,{withCredentials:!0}).then(s=>{const{ResultRoomChat:n}=s.data;o.value=n,console.log(o.value)}).catch(s=>{const{message:n}=s.response.data;console.log(s.response.status),console.log(n)}).finally(()=>{if(o.value.Messages.length>0)for(const s of o.value.Messages)s.Time=f(s.Time).format("YYYY:MM:DD HH:mm:ss");a.value.scrollTop=a.value.scrollHeight})):g.value=!1},{immediate:!0});function h(){a.value.scrollTop===0&&T()}function T(){p.post("/Direct/print_DM_Next",{Room_ID:o.value.Room_ID,Last_Chat:o.value.Messages[0].Message_ID},{withCredentials:!0}).then(l=>{const{ResultMessages:s}=l.data;o.value.Messages.unshift(...s)}).catch(l=>{console.log(l)})}P(()=>{a.value&&(a.value.addEventListener("scroll",h),w(()=>{M.value||(a.value.scrollTop=a.value.scrollHeight,M.value=!0)})),y.on("receive_message",async l=>{const{Room_ID:s,User_ID:n,Message:e,Time:i,type:k}=l;s===o.value.Room_ID&&(await o.value.Messages.push({Type:"Y",type:k,Message:e,Time:i}),a.value.scrollTop=await a.value.scrollHeight)})}),U(()=>{a.value&&a.value.removeEventListener("scroll",h)});const u=c(""),D=()=>{p.post("/Direct/send_Message",{Room_ID:o.value.Room_ID,Message:u.value},{withCredentials:!0}).then(async l=>{l.data.success&&(await o.value.Messages.push({Type:"M",type:0,Message:u.value,Time:f().format("YYYY:MM:DD HH:mm:ss")}),y.emit("send_message",{Room_ID:o.value.Room_ID,User_ID:o.value.User_ID,Message:u.value,Time:f().format("YYYY:MM:DD HH:mm:ss")}),u.value="",a.value.scrollTop=await a.value.scrollHeight)}).catch(l=>{console.log(l)})};return(l,s)=>{const n=b("router-link");return g.value?(_(),m("div",V,[t("div",$,[t("img",{src:o.value.Profile_Img,class:"RoomProfile"},null,8,z),t("div",K,v(o.value.User_Name?o.value.User_Name:"?"),1)]),t("div",{class:"RoomChat",ref_key:"RoomChatContainer",ref:a},[o.value.Messages?(_(!0),m(Y,{key:0},x(o.value.Messages,e=>(_(),m("li",null,[e.type==0?(_(),m("div",{key:0,class:R(e.Type==="M"?"m":"y")},[t("div",j,v(e.Message),1),t("div",A,v(e.Time),1)],2)):d("",!0),e.type==1?(_(),m("div",{key:1,class:R(["feed",e.Type==="M"?"m":"y"])},[e?(_(),S(n,{key:0,class:"routernone box",to:{name:"FeedDetail",params:{Post_ID:r.value[e.Message].Post_ID}}},{default:F(()=>[t("div",q,[t("img",{class:"profileImg",src:r.value[e.Message].Profile_Img,alt:""},null,8,G),t("p",null,v(r.value[e.Message].User_ID),1)]),t("img",{class:"postimg",src:r.value[e.Message].Image_Src},null,8,J),t("p",null,v(r.value[e.Message].Post_Title),1)]),_:2},1032,["to"])):d("",!0)],2)):d("",!0)]))),256)):d("",!0)],512),t("div",O,[t("div",Q,[H(t("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=e=>u.value=e),onKeyup:s[1]||(s[1]=B(e=>D(),["enter"]))},null,544),[[N,u.value]]),t("button",{onClick:s[2]||(s[2]=e=>D())},"send")])])])):d("",!0)}}},oe=E(W,[["__scopeId","data-v-658e2e99"]]);export{oe as default};
