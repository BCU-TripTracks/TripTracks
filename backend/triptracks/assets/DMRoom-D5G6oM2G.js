import{r as u,A as R,o as w,D as P,s as y,C as U,e as m,f as l,t as v,F as Y,l as x,j as d,w as H,m as S,n as N,a as p,d as _,B as C,x as B,h as L,p as b,k as F,G as E,b as V}from"./index-rxMOsmd7.js";import{h as M}from"./moment-C5S46NFB.js";import{_ as $}from"./_plugin-vue_export-helper-DlAUqK2U.js";const K=g=>(b("data-v-4c17a9ba"),g=g(),F(),g),j={key:0,class:"RoomContainer"},z={class:"RoomHeader"},A=K(()=>l("div",{class:"RoomProfile"},null,-1)),G={class:"RoomName"},q={class:"message"},J={class:"time"},O={class:"top"},Q=["src"],W=["src"],X={class:"RoomInput"},Z={class:"inputBox"},ee={__name:"DMRoom",setup(g){const T=E(),a=u(null),h=u(!1),f=u(!1),o=u({Room_ID:null,User_Name:null,Messages:[]}),i=u({});R(()=>o.value.Messages,async t=>{for(const s of o.value.Messages){const n=s.Message;s.type=="1"&&i.value[n]==null&&p.post("/feeds/Post_tinyInfo",{Post_ID:n},{withCredentials:!0}).then(e=>{console.log(n),console.log(e.data);const c=e.data;i.value[n]={Post_ID:n,User_ID:c.User_ID,User_Name:c.User_Name,Profile_Img:c.Profile_Img,Image_Src:c.Image_Src,Post_Caption:c.Post_Caption,Post_Title:c.Post_Title}}).catch(e=>{console.log(e)})}console.log(i.value)}),R(()=>T.params.Room_ID,t=>{t?(f.value=!0,p.get(`/Direct/print_DM/${t}`,{withCredentials:!0}).then(s=>{const{ResultRoomChat:n}=s.data;o.value=n,console.log(o.value)}).catch(s=>{const{message:n}=s.response.data;console.log(s.response.status),console.log(n)}).finally(()=>{if(o.value.Messages.length>0)for(const s of o.value.Messages)s.Time=M(s.Time).format("YYYY:MM:DD HH:mm:ss");a.value.scrollTop=a.value.scrollHeight})):f.value=!1},{immediate:!0});function D(){console.log(a.value.scrollTop),a.value.scrollTop===0&&k()}function k(){console.log("Loading more messages..."),p.post("/Direct/print_DM_Next",{Room_ID:o.value.Room_ID,Last_Chat:o.value.Messages[0].Message_ID},{withCredentials:!0}).then(t=>{console.log(t.data);const{ResultMessages:s}=t.data;console.log(s),o.value.Messages.unshift(...s)}).catch(t=>{console.log(t)})}w(()=>{a.value&&(a.value.addEventListener("scroll",D),P(()=>{h.value||(a.value.scrollTop=a.value.scrollHeight,h.value=!0)})),y.on("receive_message",async t=>{const{Room_ID:s,User_ID:n,Message:e,Time:c}=t;s===o.value.Room_ID&&(await o.value.Messages.push({Type:"Y",Message:e,Time:c}),a.value.scrollTop=await a.value.scrollHeight)})}),U(()=>{a.value&&a.value.removeEventListener("scroll",D)});const r=u(""),I=()=>{console.log("Sending message..."),p.post("/Direct/send_Message",{Room_ID:o.value.Room_ID,Message:r.value},{withCredentials:!0}).then(async t=>{t.data.success&&(await o.value.Messages.push({Type:"M",Message:r.value,Time:M().format("YYYY:MM:DD HH:mm:ss")}),y.emit("send_message",{Room_ID:o.value.Room_ID,User_ID:o.value.User_ID,Message:r.value,Time:M().format("YYYY:MM:DD HH:mm:ss")}),r.value="",a.value.scrollTop=await a.value.scrollHeight)}).catch(t=>{console.log(t)})};return(t,s)=>{const n=V("router-link");return f.value?(_(),m("div",j,[l("div",z,[A,l("div",G,v(o.value.User_Name?o.value.User_Name:"?"),1)]),l("div",{class:"RoomChat",ref_key:"RoomChatContainer",ref:a},[o.value.Messages?(_(!0),m(Y,{key:0},x(o.value.Messages,e=>(_(),m("li",null,[e.type==0?(_(),m("div",{key:0,class:C(e.Type==="M"?"m":"y")},[l("div",q,v(e.Message),1),l("div",J,v(e.Time),1)],2)):d("",!0),e.type==1?(_(),m("div",{key:1,class:C(["feed",e.Type==="M"?"m":"y"])},[e?(_(),B(n,{key:0,class:"routernone box",to:{name:"FeedDetail",params:{Post_ID:i.value[e.Message].Post_ID}}},{default:L(()=>[l("div",O,[l("img",{class:"profileImg",src:i.value[e.Message].Profile_Img,alt:""},null,8,Q),l("p",null,v(i.value[e.Message].User_ID),1)]),l("img",{class:"postimg",src:i.value[e.Message].Image_Src},null,8,W),l("p",null,v(i.value[e.Message].Post_Title),1)]),_:2},1032,["to"])):d("",!0)],2)):d("",!0)]))),256)):d("",!0)],512),l("div",X,[l("div",Z,[H(l("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=e=>r.value=e),onKeyup:s[1]||(s[1]=N(e=>I(),["enter"]))},null,544),[[S,r.value]]),l("button",{onClick:s[2]||(s[2]=e=>I())},"send")])])])):d("",!0)}}},te=$(ee,[["__scopeId","data-v-4c17a9ba"]]);export{te as default};
