import{r as u,A as I,o as P,D as w,s as y,C as U,e as m,f as l,t as v,F as Y,l as x,j as d,w as H,m as N,n as S,a as g,d as _,B as R,x as B,h as L,G as F,b}from"./index-fuIekYJl.js";import{h as f}from"./moment-C5S46NFB.js";import{_ as E}from"./_plugin-vue_export-helper-DlAUqK2U.js";const V={key:0,class:"RoomContainer"},$={class:"RoomHeader"},K=["src"],j={class:"RoomName"},z={class:"message"},A={class:"time"},G={class:"top"},q=["src"],J=["src"],O={class:"RoomInput"},Q={class:"inputBox"},W={__name:"DMRoom",setup(X){const C=F(),a=u(null),M=u(!1),p=u(!1),o=u({Room_ID:null,User_Name:null,Messages:[]}),i=u({});I(()=>o.value.Messages,async t=>{for(const s of o.value.Messages){const n=s.Message;s.type=="1"&&i.value[n]==null&&g.post("/feeds/Post_tinyInfo",{Post_ID:n},{withCredentials:!0}).then(e=>{console.log(n),console.log(e.data);const r=e.data;i.value[n]={Post_ID:n,User_ID:r.User_ID,User_Name:r.User_Name,Profile_Img:r.Profile_Img,Image_Src:r.Image_Src,Post_Caption:r.Post_Caption,Post_Title:r.Post_Title}}).catch(e=>{console.log(e)})}console.log(i.value)}),I(()=>C.params.Room_ID,t=>{t?(p.value=!0,g.get(`/Direct/print_DM/${t}`,{withCredentials:!0}).then(s=>{const{ResultRoomChat:n}=s.data;o.value=n,console.log(o.value)}).catch(s=>{const{message:n}=s.response.data;console.log(s.response.status),console.log(n)}).finally(()=>{if(o.value.Messages.length>0)for(const s of o.value.Messages)s.Time=f(s.Time).format("YYYY:MM:DD HH:mm:ss");a.value.scrollTop=a.value.scrollHeight})):p.value=!1},{immediate:!0});function h(){console.log(a.value.scrollTop),a.value.scrollTop===0&&T()}function T(){console.log("Loading more messages..."),g.post("/Direct/print_DM_Next",{Room_ID:o.value.Room_ID,Last_Chat:o.value.Messages[0].Message_ID},{withCredentials:!0}).then(t=>{console.log(t.data);const{ResultMessages:s}=t.data;console.log(s),o.value.Messages.unshift(...s)}).catch(t=>{console.log(t)})}P(()=>{a.value&&(a.value.addEventListener("scroll",h),w(()=>{M.value||(a.value.scrollTop=a.value.scrollHeight,M.value=!0)})),y.on("receive_message",async t=>{const{Room_ID:s,User_ID:n,Message:e,Time:r,type:k}=t;s===o.value.Room_ID&&(await o.value.Messages.push({Type:"Y",type:k,Message:e,Time:r}),a.value.scrollTop=await a.value.scrollHeight)})}),U(()=>{a.value&&a.value.removeEventListener("scroll",h)});const c=u(""),D=()=>{console.log("Sending message..."),g.post("/Direct/send_Message",{Room_ID:o.value.Room_ID,Message:c.value},{withCredentials:!0}).then(async t=>{t.data.success&&(await o.value.Messages.push({Type:"M",type:0,Message:c.value,Time:f().format("YYYY:MM:DD HH:mm:ss")}),y.emit("send_message",{Room_ID:o.value.Room_ID,User_ID:o.value.User_ID,Message:c.value,Time:f().format("YYYY:MM:DD HH:mm:ss")}),c.value="",a.value.scrollTop=await a.value.scrollHeight)}).catch(t=>{console.log(t)})};return(t,s)=>{const n=b("router-link");return p.value?(_(),m("div",V,[l("div",$,[l("img",{src:o.value.Profile_Img,class:"RoomProfile"},null,8,K),l("div",j,v(o.value.User_Name?o.value.User_Name:"?"),1)]),l("div",{class:"RoomChat",ref_key:"RoomChatContainer",ref:a},[o.value.Messages?(_(!0),m(Y,{key:0},x(o.value.Messages,e=>(_(),m("li",null,[e.type==0?(_(),m("div",{key:0,class:R(e.Type==="M"?"m":"y")},[l("div",z,v(e.Message),1),l("div",A,v(e.Time),1)],2)):d("",!0),e.type==1?(_(),m("div",{key:1,class:R(["feed",e.Type==="M"?"m":"y"])},[e?(_(),B(n,{key:0,class:"routernone box",to:{name:"FeedDetail",params:{Post_ID:i.value[e.Message].Post_ID}}},{default:L(()=>[l("div",G,[l("img",{class:"profileImg",src:i.value[e.Message].Profile_Img,alt:""},null,8,q),l("p",null,v(i.value[e.Message].User_ID),1)]),l("img",{class:"postimg",src:i.value[e.Message].Image_Src},null,8,J),l("p",null,v(i.value[e.Message].Post_Title),1)]),_:2},1032,["to"])):d("",!0)],2)):d("",!0)]))),256)):d("",!0)],512),l("div",O,[l("div",Q,[H(l("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=e=>c.value=e),onKeyup:s[1]||(s[1]=S(e=>D(),["enter"]))},null,544),[[N,c.value]]),l("button",{onClick:s[2]||(s[2]=e=>D())},"send")])])])):d("",!0)}}},oe=E(W,[["__scopeId","data-v-d870713b"]]);export{oe as default};
